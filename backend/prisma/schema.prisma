generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ENUMS

enum TeamStatus {
  ACTIVE
  DISQUALIFIED
  COMPLETED
}

enum CheckpointStatus {
  PENDING
  APPROVED
  FAILED
}

enum QuestionType {
  CODING
  NUMERICAL
  MCQ
  PHYSICAL
}

enum QuestionStatus {
  PENDING
  CORRECT
  INCORRECT
}

enum BoardRuleType {
  SNAKE
  LADDER
}

enum UserRole {
  PARTICIPANT
  ADMIN
  SUPERADMIN
}

enum RoomType {
  TECH
  NON_TECH
}

// ROOM MANAGEMENT

model Room {
  id         String   @id @default(uuid())
  roomNumber String   @unique
  capacity   Int      @default(7)
  roomType   RoomType @default(NON_TECH)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// LOGIN TABLE (Unified)

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  role      UserRole
  teamId    String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team Team? @relation(fields: [teamId], references: [id])
}

// TEAM MANAGEMENT

model Team {
  id              String     @id @default(uuid())
  teamCode        String     @unique
  teamName        String
  currentPosition Int        @default(1)
  currentRoom     String     @default("AB1 301")
  totalTimeSec    Int        @default(0)
  points          Int        @default(0)
  status          TeamStatus @default(ACTIVE)
  canRollDice     Boolean    @default(true)
  timerPaused     Boolean    @default(false)
  timerStartedAt  DateTime?
  timerPausedAt   DateTime?
  mapId           String?

  members     TeamMember[]
  checkpoints Checkpoint[]
  diceRolls   DiceRoll[]
  timeLogs    TimeLog[]
  user        User?
  map         BoardMap?    @relation(fields: [mapId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([status])
  @@index([canRollDice])
  @@index([currentPosition])
}

model TeamMember {
  id     String @id @default(uuid())
  teamId String
  name   String

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
}

// GAME FLOW

model DiceRoll {
  id           String   @id @default(uuid())
  teamId       String
  value        Int
  positionFrom Int
  positionTo   Int
  roomAssigned String
  createdAt    DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
}

model Checkpoint {
  id                  String           @id @default(uuid())
  teamId              String
  checkpointNumber    Int
  positionBefore      Int
  positionAfter       Int
  roomNumber          String
  status              CheckpointStatus @default(PENDING)
  isSnakePosition     Boolean          @default(false)
  snakeDodgeAttempted Boolean          @default(false)

  questionAssign QuestionAssignment?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, checkpointNumber])
  @@index([teamId, status])
  @@index([status])
}

// QUESTION ENGINE

model Question {
  id              String       @id @default(uuid())
  text            String
  hint            String
  isSnakeQuestion Boolean      @default(false)
  type            QuestionType @default(CODING)
  options         String[]     @default([])
  correctAnswer   String?
  isActive        Boolean      @default(true)

  assignments QuestionAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model QuestionAssignment {
  id                String         @id @default(uuid())
  checkpointId      String         @unique
  questionId        String
  status            QuestionStatus @default(PENDING)
  participantAnswer String?
  submittedAt       DateTime?
  assignedAt        DateTime       @default(now())
  answeredAt        DateTime?

  checkpoint Checkpoint @relation(fields: [checkpointId], references: [id], onDelete: Cascade)
  question   Question   @relation(fields: [questionId], references: [id])
  
  @@index([status])
  @@index([questionId])
}

// BOARD MAPS & RULES (SNAKES & LADDERS)

model BoardMap {
  id       String      @id @default(uuid())
  name     String      @unique
  isActive Boolean     @default(true)
  rules    BoardRule[]
  teams    Team[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BoardRule {
  id       String        @id @default(uuid())
  mapId    String
  type     BoardRuleType
  startPos Int

  map BoardMap @relation(fields: [mapId], references: [id], onDelete: Cascade)

  @@unique([mapId, startPos])
  @@index([mapId, type])
  @@index([mapId, type, startPos])
}

// TIMER & PENALTIES

model TimeLog {
  id        String   @id @default(uuid())
  teamId    String
  seconds   Int
  reason    String
  createdAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
}

// AUDIT LOG

model AuditLog {
  id        String   @id @default(uuid())
  actor     String
  action    String
  target    String
  details   String?
  createdAt DateTime @default(now())
}
